---
import Layout from '@layouts/Layout.astro';
import { truncateText } from '@scripts/textFormatter';
import { site } from '@config/site';
import type { ThreatMatch } from '@list/scan';

const url = Astro.url.searchParams.get('url');
if (!url) {
  return Astro.redirect('/analyze');
}

let scanResult = false;
let threatType = null;
let score = 0;
let heuristicReasons = [];
let riskLevel = 'Safe';
let detectedThreats: ThreatMatch[] = [];

try {
  const response = await fetch(`${Astro.url.origin}/api/scan`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url })
  });

  if (!response.ok) {
    throw new Error('Scan failed');
  }

  const data = await response.json();
  scanResult = data.scanResult;
  threatType = data.threatType;
  score = data.score;
  heuristicReasons = data.heuristicReasons || [];
  riskLevel = data.riskLevel;
  detectedThreats = data.detectedThreats || [];
} catch (error) {
  console.error('Error scanning URL:', error);
  return Astro.redirect('/analyze?error=scan_failed');
}

const trimmedLink = truncateText(url);
---

<Layout
  title={`result | ${url}`}
  description={`Feeling unsure about a website? ${site.name} instantly checks for scams, so you can surf with confidence`}
>
  <div class="flex flex-row top-center">
    <a class="mr-5" href="/analyze"
      ><img class="w-10 mt-px" src="./assets/svg/back.svg" alt="back" /></a
    >
    <h1 class="medium-text font-main tracking-tighter">
      Results for <a class="underline" href={`${url}`} target="_blank">{trimmedLink}</a>
    </h1>
  </div>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-10">
    <div class="c-border flex flex-col p-5">
      <p class="font-regular md-text main-color">Risk Level</p>
      <p class="font-regular sm-text main-color">
        {riskLevel} {
          riskLevel === 'Safe' ? '\u{2728}' :
          riskLevel === 'Low Risk' ? '\u{1F440}' :
          riskLevel === 'Medium Risk' ? '\u{1FAA6}' :
          '\u{1F480}'
        }
      </p>
    </div>
    <div class="c-border flex flex-col p-5">
      <p class="font-regular md-text main-color">Google Rating</p>
      {
        scanResult === null ? (
          <p class="font-regular sm-text main-color">Unknown</p>
        ) : scanResult ? (
          <p class="font-regular sm-text main-color">Malicious</p>
        ) : (
          <p class="font-regular sm-text main-color">Safe</p>
        )
      }
    </div>
    <div class="c-border p-5 flex flex-col">
      <p class="font-regular md-text main-color">Type</p>
      {
        scanResult ? (
          threatType === 'MALWARE' ? (
            <p class="font-regular sm-text main-color">Malware</p>
          ) : threatType === 'SOCIAL_ENGINEERING' ? (
            <p class="font-regular sm-text main-color">Social Engineering</p>
          ) : (
            <p class="font-regular sm-text main-color">Unknown</p>
          )
        ) : (
          <p class="font-regular sm-text main-color">Secure</p>
        )
      }
    </div>
    <div class="c-border flex flex-col p-5">
      <p class="font-regular md-text main-color">Score</p>
      <p class="font-regular sm-text main-color">{score}</p>
    </div>
    {detectedThreats.length > 0 && (
      <div class="c-border col-span-full flex flex-col p-5">
        <p class="font-regular md-text main-color">Detected Threats</p>
        <ul class="list-disc list-inside font-regular sm-text main-color mt-2">
          {detectedThreats.map((threat: ThreatMatch) => (
            <li>
              <span class="font-bold">{threat.source}:</span> {threat.type}
            </li>
          ))}
        </ul>
      </div>
    )}
    <div class="c-border flex flex-col gap-5 font-medium p-5">
      <a
        target="_blank"
        class="main-btn w-fit mx-auto text-center"
        href="https://safebrowsing.google.com/safebrowsing/report_phish">Report to Google</a
      >
      <a
        target="_blank"
        class="main-btn w-fit mx-auto text-center"
        href="https://microsoft.com/wdsi/support/report-unsafe-site">Report to Microsoft</a
      >
    </div>
    <a class="c-border p-5 hover-bg" href="/sponsor" target="_blank">
      <img class="w-20 my-5 mx-auto" src="./assets/svg/heart.svg" alt="Sponsor" />
    </a>
  </div>
</Layout>
